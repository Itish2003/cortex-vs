# Cortex Mentor VS Code Extension

This is the frontend VS Code extension for the Cortex Mentor project. It connects to the backend server, receives real-time audio insights, and plays them to the user.

## Features

*   **Real-time Audio Insights**: Automatically receives and plays audio insights generated by the Cortex Mentor backend.
*   **Status Bar Integration**: Provides a status bar item to show the current connection status to the backend.
*   **Manual Connection Control**: Allows users to manually connect and disconnect from the backend via the Command Palette.

## Requirements

*   The Cortex Mentor backend server must be running. See the `README.md` in the parent `cortex_mentor` directory for instructions.

## How to Run in Development

1.  **Install Dependencies**:
    ```bash
    npm install
    ```
2.  **Start the Extension**:
    *   Open this `cortex-vs` directory in VS Code.
    *   Press `F5` to open a new Extension Development Host window with the extension running.

## How to Use

1.  **Start the Backend**: Make sure your Cortex Mentor backend server (FastAPI and ARQ worker) is running.
2.  **Run the Extension**: Follow the steps above to run the extension in a development window.
3.  **Connect**: The extension will attempt to connect automatically. You can monitor the connection status in the VS Code status bar.
    *   `$(sync~spin) Cortex`: Connecting...
    *   `$(zap) Cortex`: Connected
    *   `$(plug) Cortex`: Disconnected
    *   `$(error) Cortex`: Error
4.  **Use Commands**: Open the Command Palette (`Cmd+Shift+P` or `Ctrl+Shift+P`) and type "Cortex" to access the following commands:
    *   `Cortex: Connect`: Manually connect to the backend.
    *   `Cortex: Disconnect`: Manually disconnect from the backend.
5.  **Receive Insights**: As you work and trigger events that the backend processes, you will hear audio insights played directly in your editor.

## Testing

The extension includes a comprehensive test suite for unit and integration testing.

### Running Tests

```bash
# Run all tests with coverage
npm test

# Run type checking only
npm run check-types

# Run linting only
npm run lint

# Compile the extension (includes type checking and linting)
npm run compile
```

### Test Files

| File | Description |
|------|-------------|
| `src/test/extension.test.ts` | Extension activation, command registration, and configuration tests |
| `src/test/chatViewProvider.test.ts` | ChatViewProvider unit tests for message handling and state management |
| `src/test/websocket.test.ts` | WebSocket client configuration, message parsing, and connection state tests |

### Test Categories

#### Extension Tests (`extension.test.ts`)
- Extension activation and lifecycle
- Command registration (`cortex-vs.connect`, `cortex-vs.disconnect`, `cortex.saveChatHistory`, `cortex.loadChatHistory`)
- Configuration settings (`cortex.backendUrl`)
- View contributions (sidebar, chat view)

#### ChatViewProvider Tests (`chatViewProvider.test.ts`)
- Provider instantiation and view type
- Connection status updates
- Message queuing before view resolution
- History loading
- Edge cases (empty audio, long text, special characters)

#### WebSocket Tests (`websocket.test.ts`)
- WebSocket URL configuration
- Message parsing and validation
- Connection state management
- Error handling (connection refused, timeout, network errors)
- Reconnection behavior

### Coverage Requirements

- Minimum coverage threshold: **60%**
- Coverage reports are generated in `coverage/` directory

### Writing New Tests

```typescript
import * as assert from 'assert';
import * as vscode from 'vscode';

suite('My Test Suite', () => {
    test('Should do something', async () => {
        const result = await someFunction();
        assert.strictEqual(result, expectedValue);
    });
});
```

### Debugging Tests

1. Open the `cortex-vs` directory in VS Code
2. Go to the Debug panel (Cmd+Shift+D / Ctrl+Shift+D)
3. Select "Extension Tests" from the dropdown
4. Press F5 to run tests with debugger attached

---

**Enjoy!**
